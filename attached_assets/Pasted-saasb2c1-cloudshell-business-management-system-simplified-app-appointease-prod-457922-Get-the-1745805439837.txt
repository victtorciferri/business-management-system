saasb2c1@cloudshell:~/business-management-system/simplified-app (appointease-prod-457922)$ # Get the Cloud SQL instance name
INSTANCE_NAME=$(gcloud sql instances list --format="value(name)")

# Configure the Cloud SQL instance to allow connections from anywhere (for now)
gcloud sql instances patch $INSTANCE_NAME --authorized-networks=0.0.0.0/0

# Generate a proper Cloud SQL connection string for Cloud Run
# This will include the Cloud SQL Auth Proxy connection
PROJECT_ID=$(gcloud config get-value project)
REGION=southamerica-west1
INSTANCE_CONNECTION_NAME="${PROJECT_ID}:${REGION}:${INSTANCE_NAME}"

# Configure the service account for Cloud Run to connect to Cloud SQL
gcloud run services update appointease \
  --add-cloudsql-instances=$INSTANCE_CONNECTION_NAME \
  --region=$REGION

# Update the database URL secret to use the proxy connection format
PROXY_DB_URL="postgresql://postgres:postgres@localhost/postgres"
echo $PROXY_DB_URL | gcloud secrets versions add database-url --data-file=-

# Update the application to use the Cloud SQL Auth Proxy
cat > index.js << 'EOF'
const express = require('express');
const fs = require('fs');
const path = require('path');
const { Pool } = require('pg');
const session = require('express-session');
const memoryStore = require('memorystore')(session);
const app = express();
const port = process.env.PORT || 8080;

// Enable detailed logging
const DEBUG = true;

// In-memory fallback data
const inMemoryUsers = [{
  --add-cloudsql-instances=${INSTANCE_CONNECTION_NAME}\pointease-secret-key,CLOUD_SQL_CONNECTION_NAME=${INSTANCE_CONNECTION_NAME}" \correctly.</p>
When adding a new IP address to authorized networks, make sure to also include any IP addresses that have already been authorized. Otherwise, they will be overwritten and de-authorized.

Do you want to continue (Y/n)?  y

The following message will be used for the patch API method.
{"name": "appointease-db", "project": "appointease-prod-457922", "settings": {"ipConfiguration": {"authorizedNetworks": [{"value": "0.0.0.0/0"}]}}}
Patching Cloud SQL instance...done.                                                                                                                                                         
Updated [https://sqladmin.googleapis.com/sql/v1beta4/projects/appointease-prod-457922/instances/appointease-db].
Your active configuration is: [cloudshell-14847]
OK Deploying... Done.                                                                                                                                                                       
  OK Creating Revision...                                                                                                                                                                   
  OK Routing traffic...                                                                                                                                                                     
Done.                                                                                                                                                                                       
Service [appointease] revision [appointease-00051-cnd] has been deployed and is serving 100 percent of traffic.
Service URL: https://appointease-249754346416.southamerica-west1.run.app
Created version [4] of the secret [database-url].
Building using Dockerfile and deploying container to Cloud Run service [appointease] in project [appointease-prod-457922] region [southamerica-west1]
\  Building and deploying... Uploading sources.                                                                                                                                             
|  Building and deploying... Uploading sources.                                                                                                                                             
OK Building and deploying... Done.                                                                                                                                                          
  OK Uploading sources...                                                                                                                                                                   
  OK Building Container... Logs are available at [https://console.cloud.google.com/cloud-build/builds;region=southamerica-west1/394a787d-86a0-4ed8-81e0-e17b1810bdc2?project=249754346416]. 
  OK Creating Revision...                                                                                                                                                                   
  OK Routing traffic...                                                                                                                                                                     
  OK Setting IAM Policy...                                                                                                                                                                  
Done.                                                                                                                                                                                       
Service [appointease] revision [appointease-00052-cwm] has been deployed and is serving 100 percent of traffic.
Service URL: https://appointease-249754346416.southamerica-west1.run.app
saasb2c1@cloudshell:~/business-management-system/simplified-app (appointease-prod-457922)$ 