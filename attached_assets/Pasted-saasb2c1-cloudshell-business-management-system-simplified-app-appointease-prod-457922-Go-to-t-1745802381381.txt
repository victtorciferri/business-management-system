saasb2c1@cloudshell:~/business-management-system/simplified-app (appointease-prod-457922)$ # Go to the simplified app directory
cd ~/business-management-system/simplified-app

# Get the correct service account
SERVICE_ACCOUNT=$(gcloud run services describe appointease --region=southamerica-west1 --format='value(serviceAccountEmail)')
echo "Service account: $SERVICE_ACCOUNT"

# Grant access to the new-database-url secret
gcloud secrets add-iam-policy-binding new-database-url \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

# Let's verify the permissions
gcloud secrets get-iam-policy new-database-url

# Get the database IP address
DB_IP=$(gcloud sql instances describe appointease-db --format='value(ipAddresses[0].ipAddress)')
echo "Database IP: $DB_IP"

# Create the database URL manually
NEW_DB_URL="postgres://appointease:appointease-db-password@${DB_IP}:5432/appointease"

# Update the secret
echo -n "$NEW_DB_URL" | gcloud secrets versions add new-database-url --data-file=-

# Now deploy with the fixed permissions
gcloud run deploy appointease \
  --source . \
  --region=southamerica-west1 \
  --platform=managed \
  --allow-unauthenticated \
  --set-env-vars="NODE_ENV=production,SESSION_SECRET=appointease-secret-key" \
  --update-secrets="DATABASE_URL=new-database-url:latest"
Service account: 
ERROR: (gcloud.secrets.add-iam-policy-binding) Status code: 400. Invalid service account ()..
etag: ACAB
Database IP: 34.176.74.36
Created version [2] of the secret [new-database-url].
Building using Dockerfile and deploying container to Cloud Run service [appointease] in project [appointease-prod-457922] region [southamerica-west1]
-  Building and deploying... Uploading sources.                                                                                                                                             
-  Building and deploying... Uploading sources.                                                                                                                                             
X  Building and deploying... Building Container.                                                                                                                                            
  OK Uploading sources...                                                                                                                                                                   
  OK Building Container... Logs are available at [https://console.cloud.google.com/cloud-build/builds;region=southamerica-west1/1ca91919-c583-4371-8dd4-0d7cfd1dcc80?project=249754346416]. 
  -  Creating Revision...                                                                                                                                                                   
Creating temporary archive of 773 file(s) totalling 3.9 MiB before compression.
  OK Setting IAM Policy...                                                                                                                                                                  
Deployment failed                                                                                                                                                                           
ERROR: (gcloud.run.deploy) Revision 'appointease-00046-msp' is not ready and cannot serve traffic. spec.template.spec.containers[0].env[0].value_from.secret_key_ref.name: Permission denied on secret: projects/249754346416/secrets/new-database-url/versions/latest for Revision service account 249754346416-compute@developer.gserviceaccount.com. The service account used must be granted the 'Secret Manager Secret Accessor' role (roles/secretmanager.secretAccessor) at the secret, project or higher level.
saasb2c1@cloudshell:~/business-management-system/simplified-app (appointease-prod-457922)$ 