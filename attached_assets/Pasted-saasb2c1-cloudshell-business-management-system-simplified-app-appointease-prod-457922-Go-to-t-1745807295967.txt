saasb2c1@cloudshell:~/business-management-system/simplified-app (appointease-prod-457922)$ # Go to the simplified app directory
cd ~/business-management-system/simplified-app

# Create an updated index.js that uses the working connection approach from the diagnostic app
cat > index.js << 'EOF'
const express = require('express');
const fs = require('fs');
const path = require('path');
const { Pool } = require('pg');
const session = require('express-session');
const memoryStore = require('memorystore')(session);
const app = express();
const port = process.env.PORT || 8080;

// Enable detailed logging
const DEBUG = true;

// Database connection configuration - using the WORKING approach from the diagnostic app
const pool = new Pool({
  connectionString: 'postgresql://postgres:AppointEase123!@localhost:5432/postgres'
});

// Add database error handler
pool.on('error', (err) => {
  console.error('Unexpected database error:', err);
});

// Try to connect to the database
async function testDbConnection() {
  let client;
  try {
    console.log('Testing database connection...');
    client = await pool.connect();
    const result = await client.query('SELECT NOW() as time');
    console.log('Database connection successful:', result.rows[0]);
    return true;
  } catch (err) {
  --add-cloudsql-instances=${INSTANCE_CONNECTION_NAME}ppointease-secret-key,CLOUD_SQL_CONNECTION_NAME=${INSTANCE_CONNECTION_NAME}" \
Your active configuration is: [cloudshell-14847]
Building using Dockerfile and deploying container to Cloud Run service [appointease] in project [appointease-prod-457922] region [southamerica-west1]
/  Building and deploying... Uploading sources.                                                                                                                                             
-  Building and deploying... Uploading sources.                                                                                                                                             
X  Building and deploying... Building Container.                                                                                                                                            
  OK Uploading sources...                                                                                                                                                                   
  OK Building Container... Logs are available at [https://console.cloud.google.com/cloud-build/builds;region=southamerica-west1/94386fea-5515-485c-8041-3a3dd2429946?project=249754346416]. 
  -  Creating Revision...                                                                                                                                                                   
Creating temporary archive of 854 file(s) totalling 29.5 MiB before compression.
  OK Setting IAM Policy...                                                                                                                                                                  
Deployment failed                                                                                                                                                                           
ERROR: (gcloud.run.deploy) Revision 'appointease-00057-vkf' is not ready and cannot serve traffic. The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable within the allocated timeout. This can happen when the container port is misconfigured or if the timeout is too short. The health check timeout can be extended. Logs for this revision might contain more information.

Logs URL: https://console.cloud.google.com/logs/viewer?project=appointease-prod-457922&resource=cloud_run_revision/service_name/appointease/revision_name/appointease-00057-vkf&advancedFilter=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22appointease%22%0Aresource.labels.revision_name%3D%22appointease-00057-vkf%22 
For more troubleshooting guidance, see https://cloud.google.com/run/docs/troubleshooting#container-failed-to-start
saasb2c1@cloudshell:~/business-management-system/simplified-app (appointease-prod-457922)$ 